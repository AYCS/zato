{% extends "zato/index.html" %}

{% block extra_css %}
    <link rel="stylesheet" type="text/css" href="/static/css/jquery.alerts.css">
{% endblock %}

{% block extra_js %}

    {% comment %} jQuery {% endcomment %}
    <script type="text/javascript" src="/static/jquery/jquery.tablesorter.min.js"></script>
    <script type="text/javascript" src="/static/jquery/jquery.cookie.js"></script>
    <script type="text/javascript" src="/static/jquery/jquery.alerts.min.js"></script>

    {% comment %} Common JS {% endcomment %}
    <script type="text/javascript" src="/static/js/common.js"></script>

    {% comment %} HTTP Basic Auth {% endcomment %}
    <script type="text/javascript" src="/static/js/cluster.js"></script>


    <script>
    $.fn.zato.data_table.get_columns = function() {
        return [
            '_numbering',
            '_selection',
            '_cluster',
            '_addresses',
            '_edit',
            '_delete',
            '_manage_lb',
            '_add_remove_servers',
            
            'id',
            'name',
            'description',
            'odb_type',
            
            'odb_host',
            'odb_port',
            'odb_db_name',
            'odb_user',
            'odb_schema',
            'lb_host',
            'lb_port',
            'lb_agent_port',
            'broker_host',
            'broker_start_port',
            'broker_token',
        ]
    }
    </script>

{% endblock %}

{% block content %}
<h2 class="zato">Clusters</h2>


    <div id="user-message-div" style='display:none'><pre id="user-message" class="user-message"></pre></div>

    <div class='page_prompt'>
        <a href="javascript:$.fn.zato.cluster.create()">Create a new cluster</a>
    </div>

    <div id="markup">
        <table id="data-table">
            <thead>

                <tr>
                    <th>&nbsp;</th>
                    <th>&nbsp;</th>
                    <th>Cluster</th>
                    <th>Addresses</th>
                    <th>&nbsp;</th>
                    <th>&nbsp;</th>
                    <th>&nbsp;</th>
                    <th>&nbsp;</th>
                    
                    <th class='ignore'>&nbsp;</th>
                    <th class='ignore'>&nbsp;</th>
                    <th class='ignore'>&nbsp;</th>
                    <th class='ignore'>&nbsp;</th>
                    
                    <th class='ignore'>&nbsp;</th>
                    <th class='ignore'>&nbsp;</th>
                    <th class='ignore'>&nbsp;</th>
                    <th class='ignore'>&nbsp;</th>
                    <th class='ignore'>&nbsp;</th>
                    <th class='ignore'>&nbsp;</th>
                    <th class='ignore'>&nbsp;</th>
                    <th class='ignore'>&nbsp;</th>
                    <th class='ignore'>&nbsp;</th>
                    <th class='ignore'>&nbsp;</th>
                    <th class='ignore'>&nbsp;</th>
                </tr>
            </thead>

            <tbody>
            
            {% if items %}
            {% for item in items %}
                <tr 
                    class="{% if not item.lb_config or not item.all_up %}attention{% else %} {% cycle 'odd' 'even' %}{% endif %}"
                        id='tr_{{ item.id }}'>
                    
                    <td class='numbering'>&nbsp;</td>
                    <td><input type="checkbox" /></td>
                    <td>{{ item.name }}

                    {% if item.description %}
                        <br/>
                        <pre>{{ item.description }}</pre>
                    {% endif %}
                    
                    {% if not item.lb_config %}
                    <br/> Could not fetch the load balancer's configuration
                    {% endif %}
                    

                    {% if item.lb_config %}
                        {% include "zato/cluster/servers_state.html" %}
                    {% endif %}

                    </td>
                    <td>
                    
                    {% if item.lb_config %}
                        {% include "zato/cluster/addresses.html" %}
                    {% endif %}

                    </td>
                    <td>
                        <a href="javascript:$.fn.zato.cluster.edit('{{ item.id }}')">Edit</a>
                    </td>
                    <td>
                        <a href="javascript:$.fn.zato.cluster.delete_('{{ item.id }}')">Delete</a>
                    </td>
                    <td>
                        {% if item.lb_config %}
                            <a href="{% url lb-manage item.id %}">Manage load balancer</a>
                        {% endif %}
                    </td>
                    <td>
                        {% if item.lb_config %}
                            <a href="javascript:$.fn.zato.cluster.add_remove_servers('{{ item.id }}')">Add/remove servers</a>
                        {% endif %}
                        
                    </td>
                    
                    <td class='ignore item_id_{{ item.id }}'>{{ item.id }}</td>
                    <td class='ignore'>{{ item.name }}</td>
                    <td class='ignore'>{{ item.description|default_if_none:'' }}</td>
                    <td class='ignore'>{{ item.odb_type }}</td>
                    
                    <td class='ignore'>{{ item.odb_host }}</td>
                    <td class='ignore'>{{ item.odb_port }}</td>
                    <td class='ignore'>{{ item.odb_db_name }}</td>
                    <td class='ignore'>{{ item.odb_user }}</td>
                    <td class='ignore'>{{ item.odb_schema|default_if_none:'' }}</td>
                    <td class='ignore'>{{ item.lb_host }}</td>
                    <td class='ignore'>{{ item.lb_port }}</td>
                    <td class='ignore'>{{ item.lb_agent_port }}</td>
                    <td class='ignore'>{{ item.broker_host }}</td>
                    <td class='ignore'>{{ item.broker_start_port }}</td>
                    <td class='ignore'>{{ item.broker_token }}</td>
                </tr>
            {% endfor %}
            {% else %}
                <tr>
                    <td colspan='23'>No results</td>
                </tr>
            {% endif %}

            </tbody>
        </table>
    </div>

    <div id="create-div" class='data-popup ignore'>
        <div class="bd">
            <form action="{% url cluster-create %}" method="post" id="create-form">
                <table class="form-data">
                    <tr>
                        <td style="vertical-align:middle;width:15%">Name</td>
                        <td colspan="5">{{ create_form.name }}</td>
                    </tr>
                    <tr>
                        <td style="vertical-align:middle">Description</td>
                        <td colspan="5">{{ create_form.description }}</td>
                    </tr>
                    <tr>
                        <td style="vertical-align:middle">ODB type</td>
                        <td>{{ create_form.odb_type }}</td>
                        <td style="vertical-align:middle">ODB host</td>
                        <td>{{ create_form.odb_host }}</td>
                        <td style="vertical-align:middle">ODB port</td>
                        <td>{{ create_form.odb_port }}</td>
                    </tr>
                    <tr>
                        <td style="vertical-align:middle">ODB name</td>
                        <td>{{ create_form.odb_db_name }}</td>
                        <td style="vertical-align:middle">ODB user</td>
                        <td>{{ create_form.odb_user }}</td>
                        <td style="vertical-align:middle">ODB schema</td>
                        <td>{{ create_form.odb_schema }}</td>
                    </tr>
                    <tr>
                        <td style="vertical-align:middle">LB host</td>
                        <td>{{ create_form.lb_host }}</td>
                        <td style="vertical-align:middle">LB port</td>
                        <td>{{ create_form.lb_port }}</td>
                        <td style="vertical-align:middle">LB agent port</td>
                        <td>{{ create_form.lb_agent_port }}</td>
                    </tr>
                    <tr>
                        <td style="vertical-align:middle">Broker host</td>
                        <td colspan='2'>{{ create_form.broker_host }}</td>
                        <td style="vertical-align:middle">Broker starting port</td>
                        <td colspan='2'>{{ create_form.broker_start_port }}</td>
                    </tr>
                    <tr>
                        <td style="vertical-align:middle">Broker token<br/>(will be echoed)</td>
                        <td colspan='5' style="vertical-align:middle">{{ create_form.broker_token }}</td>
                    </tr>
                    <tr>
                        <td colspan="6" style="text-align:right">
                            <input type="submit" value="OK" />
                            <button type='button' onclick='javascript:$.fn.zato.data_table.close(this)'>Cancel</button>
                        </td>
                    </tr>
                </table>
            </form>
        </div>
    </div>

    <div id="edit-div" class='data-popup ignore'>
        <div class="bd">
            <form action="{% url cluster-edit %}" method="post" id="edit-form">
                <table class="form-data">
                    <tr>
                        <td style="vertical-align:middle;width:15%">Name</td>
                        <td colspan="5">{{ edit_form.name }}</td>
                    </tr>
                    <tr>
                        <td style="vertical-align:middle">Description</td>
                        <td colspan="5">{{ edit_form.description }}</td>
                    </tr>
                    <tr>
                        <td style="vertical-align:middle">ODB type</td>
                        <td>{{ edit_form.odb_type }}</td>
                        <td style="vertical-align:middle">ODB host</td>
                        <td>{{ edit_form.odb_host }}</td>
                        <td style="vertical-align:middle">ODB port</td>
                        <td>{{ edit_form.odb_port }}</td>
                    </tr>
                    <tr>
                        <td style="vertical-align:middle">ODB name</td>
                        <td>{{ edit_form.odb_db_name }}</td>
                        <td style="vertical-align:middle">ODB user</td>
                        <td>{{ edit_form.odb_user }}</td>
                        <td style="vertical-align:middle">ODB schema</td>
                        <td>{{ edit_form.odb_schema }}</td>
                    </tr>
                    <tr>
                        <td style="vertical-align:middle">LB host</td>
                        <td>{{ edit_form.lb_host }}</td>
                        <td style="vertical-align:middle">LB port</td>
                        <td>{{ edit_form.lb_port }}</td>
                        <td style="vertical-align:middle">LB agent port</td>
                        <td>{{ edit_form.lb_agent_port }}</td>
                    </tr>
                    <tr>
                        <td style="vertical-align:middle">Broker host</td>
                        <td colspan='2'>{{ edit_form.broker_host }}</td>
                        <td style="vertical-align:middle">Broker starting port</td>
                        <td colspan='2'>{{ edit_form.broker_start_port }}</td>
                    </tr>
                    <tr>
                        <td style="vertical-align:middle">Broker token<br/>(will be echoed)</td>
                        <td colspan='5' style="vertical-align:middle">{{ edit_form.broker_token }}</td>
                    </tr>
                    <tr>
                        <td colspan="6" style="text-align:right">
                            <input type="submit" value="OK" />
                            <button type='button' onclick='javascript:$.fn.zato.data_table.close(this)'>Cancel</button>
                        </td>
                    </tr>
                </table>
                <input type="hidden" id="id_edit-id" name="id" />
            </form>
        </div>
    </div>

{% endblock %}
